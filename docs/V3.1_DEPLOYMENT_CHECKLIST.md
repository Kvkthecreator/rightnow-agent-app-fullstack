# V3.1 Deployment Checklist

**Date**: 2025-10-16
**Status**: Ready for Manual Testing

## Changes Deployed

### 1. Frontend Schema Alignment (Option 2 Complete)

**Files Modified:**
- ‚úÖ [app/api/baskets/[id]/uploads/route.ts](../web/app/api/baskets/[id]/uploads/route.ts) - Removed context_items query
- ‚úÖ [app/baskets/[id]/uploads/UploadsClient.tsx](../web/app/baskets/[id]/uploads/UploadsClient.tsx) - Removed context_items UI
- ‚úÖ [app/api/baskets/[id]/purge/route.ts](../web/app/api/baskets/[id]/purge/route.ts) - Removed context_items purge
- ‚úÖ [app/api/baskets/[id]/purge/preview/route.ts](../web/app/api/baskets/[id]/purge/preview/route.ts) - Removed context_items count
- ‚úÖ [app/baskets/[id]/settings/DangerZoneClient.tsx](../web/app/baskets/[id]/settings/DangerZoneClient.tsx) - Removed context_items display
- ‚úÖ [app/baskets/[id]/graph/page.tsx](../web/app/baskets/[id]/graph/page.tsx) - Complete rebuild for V3.1
- ‚úÖ [components/graph/CausalGraphView.tsx](../web/components/graph/CausalGraphView.tsx) - New visualization

**Schema Fixes:**
- ‚úÖ Removed queries to deleted `context_items` table
- ‚úÖ Updated to query `substrate_relationships` table
- ‚úÖ Fixed relationship query to use `state` instead of `status`
- ‚úÖ Filter relationships by basket's blocks (via `blockIds.in()`)

### 2. Automated Testing Completed

**TypeScript Compilation:**
- ‚úÖ No TypeScript errors in modified files
- ‚úÖ Next.js dev server starts without errors
- ‚úÖ No runtime compilation errors

**Schema Validation:**
- ‚úÖ Verified `substrate_relationships` table schema
- ‚úÖ Confirmed column names match queries
- ‚úÖ Validated relationship types (addresses, supports, contradicts, depends_on)

### 3. Manual Testing Required

**Critical Paths to Test:**

#### A. Uploads Page (`/baskets/[id]/uploads`)
- [ ] Page loads without errors
- [ ] Shows uploads list correctly
- [ ] Stats show "X total uploads" and "Y blocks extracted"
- [ ] No "meanings extracted" badge (removed)
- [ ] Upload detail modals work

**Expected**: Page works normally, just without context_items references

---

#### B. Graph Page (`/baskets/[id]/graph`)
- [ ] Page loads without errors
- [ ] Shows causal relationship graph
- [ ] Stats cards show: Blocks, Relationships, Visible Nodes, Visible Links
- [ ] Relationship type filters work (addresses, supports, contradicts, depends_on)
- [ ] Confidence slider filters relationships
- [ ] Node colors vary by semantic_type
- [ ] Relationship arrows show directionally
- [ ] Click node ‚Üí shows details panel
- [ ] Zoom controls work

**Expected**: New force-directed graph visualizing causal relationships

**Note**: Graph will be empty until relationships are inferred via P2

---

#### C. Settings Danger Zone (`/baskets/[id]/settings`)
- [ ] Page loads without errors
- [ ] Preview shows "X Blocks, Y Dumps" (no context_items)
- [ ] Archive all mode works
- [ ] Redact dumps mode works
- [ ] Confirmation text validation works

**Expected**: Purge operations work without context_items

---

#### D. Purge API Endpoints
- [ ] `GET /api/baskets/[id]/purge/preview` returns `{blocks, dumps}`
- [ ] `POST /api/baskets/[id]/purge` with mode=archive_all works
- [ ] `POST /api/baskets/[id]/purge` with mode=redact_dumps works

**Expected**: API responses match new schema (no context_items field)

---

### 4. V3.1 Semantic Layer Testing

**Test Case**: [TEST_CAUSAL_RELATIONSHIPS.md](./TEST_CAUSAL_RELATIONSHIPS.md)

**Steps:**
1. [ ] Add Memory 1 (Problem: User Churn)
2. [ ] Add Memory 2 (Solution: Increase Free Tier)
3. [ ] Add Memory 3 (Evidence: A/B Test Results)
4. [ ] Verify P2 infers 3 relationships:
   - Memory 2 ADDRESSES Memory 1
   - Memory 3 SUPPORTS Memory 2
   - Memory 3 SUPPORTS Memory 1

**Verification Query:**
```sql
SELECT
  r.relationship_type,
  r.confidence_score,
  r.state,
  from_block.title as from_title,
  to_block.title as to_title
FROM substrate_relationships r
JOIN blocks from_block ON r.from_block_id = from_block.id
JOIN blocks to_block ON r.to_block_id = to_block.id
WHERE from_block.basket_id = 'YOUR_BASKET_ID'
ORDER BY r.created_at DESC;
```

**Expected Output:**
```
relationship_type | confidence | state    | from_title            | to_title
------------------|------------|----------|----------------------|--------------------
supports          | 0.92       | ACCEPTED | A/B Test Results     | Increase Free Tier
supports          | 0.78       | ACCEPTED | A/B Test Results     | User Churn Problem
addresses         | 0.87       | ACCEPTED | Increase Free Tier   | User Churn Problem
```

---

### 5. Known Issues / Limitations

**Graph Page:**
- Relationships only show blocks within the same basket
- Empty state displayed when no relationships exist
- Maximum 500 blocks, 2000 relationships per basket
- Only shows ACCEPTED state relationships

**Semantic Layer:**
- P2 inference requires at least 2 blocks in basket
- Relationship candidates found via semantic search (similarity > 0.70)
- LLM verification required (gpt-4o-mini)
- High confidence (>0.90) auto-approved, others proposed

---

### 6. Rollback Plan

If critical issues found:

```bash
# Revert schema alignment changes
git revert b97d36fa

# Revert graph query fixes
git revert HEAD

# Restart services
npm run dev
```

**Note**: This will restore context_items queries (which will fail on production DB where table is deleted)

---

### 7. Next Steps (Post-Deployment)

**Option A: Complete Schema Audit (P1/P2 fixes)**
- Settings maintenance page
- Proposal approval UI
- Comment threads
- Deprecation widgets

**Estimated**: 2-3 hours

**Option B: Enhance Graph Visualization**
- Detailed node panels
- Relationship reasoning display
- Clustering by semantic_type
- Export functionality

**Estimated**: 4-6 hours

**Option C: Add Semantic Search UI**
- "Find similar blocks" feature
- Semantic search bar
- "Why related?" explanations
- Duplicate detection preview

**Estimated**: 6-8 hours

---

### 8. Deployment Commands

```bash
# Commit graph query fixes
git add web/app/baskets/[id]/graph/page.tsx
git commit -m "Fix graph page relationship queries"

# Push to production
git push origin main
```

---

## Summary

**Automated Testing**: ‚úÖ Complete (TypeScript, compilation, schema validation)
**Manual Testing**: ‚è≥ Required (UI functionality, API endpoints)
**V3.1 Test Case**: üìã Ready to execute
**Deployment Status**: ‚ö†Ô∏è Pending manual verification

**Recommendation**: Test critical paths (uploads, graph, settings) before pushing to production.
