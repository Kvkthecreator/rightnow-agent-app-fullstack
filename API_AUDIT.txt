================================================================================
RIGHTNOW AGENT APP: API SURFACE AUDIT REPORT
================================================================================
Date: November 2, 2025 | Status: COMPLETE & CONSOLIDATED

KEY FINDINGS
================================================================================

FINDING 1: Current API (v2.1) Is Functional
   Status: OPERATIONAL
   - 45+ endpoints across 25 route files
   - Work queue: /api/work/* (7 endpoints)
   - Baskets: /baskets/new, /baskets/{id}/snapshot
   - Substrate: /blocks/* (governance + proposals)
   - Documents: /api/documents/* (UNGOVERNED, direct mutations)
   - Reflections: /api/reflections/* (UNGOVERNED, direct mutations)
   - MCP: /mcp/* (OAuth, activity, inference)
   - Monitoring: /health/*, /alerts/*

FINDING 2: V4 Unified Approval Is Orphaned
   Status: SCHEMA + CODE READY, API UNWIRED
   - Database: 5 tables created (work_sessions, work_artifacts, work_checkpoints, 
     work_iterations, work_context_mutations)
   - Code: UnifiedApprovalOrchestrator class fully implemented
   - API: ZERO routes wired to these components
   - Evidence: grep "work_sessions\|work_artifacts\|work_checkpoints" /api/src/app/routes/
     → Returns ZERO matches (only governance/unified_approval.py, never called)

FINDING 3: Governance Gap
   Status: PARTIAL IMPLEMENTATION
   - Substrate blocks: GOVERNED (propose → approve → execute)
   - Documents: UNGOVERNED (direct creation)
   - Reflections: UNGOVERNED (direct computation)
   - V4 Plan: Unify all three types under work_sessions (not implemented)

================================================================================
CURRENT API CONTRACTS (What Works Today)
================================================================================

WORK ORCHESTRATION (7 endpoints)
   GET  /api/work/health
   GET  /api/work/{work_id}/status
   GET  /api/work/?work_type=&status=&basket_id=
   POST /api/work/initiate
   POST /api/work/{work_id}/retry
   GET  /api/work/{work_id}/cascade
   GET  /api/work/workspace/{workspace_id}/summary

BASKET & SUBSTRATE MANAGEMENT (6 endpoints)
   POST /baskets/new (idempotent)
   GET  /baskets/{basket_id}/snapshot
   GET  /baskets/{basket_id}/blocks
   POST /blocks/baskets/{basket_id}/propose (create proposal)
   POST /blocks/{block_id}/approve (execute governance)
   GET  /blocks/baskets/{basket_id}/proposed (list pending)

DOCUMENT COMPOSITION (Direct, No Governance)
   POST /api/documents/compose-contextual
   PUT  /api/documents/{document_id}/recompose-contextual

REFLECTION OPERATIONS (Direct, No Governance)
   POST /api/reflections/compute_window
   POST /api/reflections/compute_event
   POST /api/reflections/documents/{document_id}/compute

MCP INTEGRATION (6 endpoints)
   POST /mcp/auth/sessions (OAuth token storage)
   POST /mcp/auth/sessions/validate
   POST /mcp/activity/ (activity logging)
   GET  /mcp/activity/summary
   POST /mcp/baskets/infer (fingerprint inference)

MONITORING (3+ endpoints)
   GET  /health/basket/{basket_id}
   GET  /health/workspace/{workspace_id}
   GET  /alerts/current

Total: 45+ endpoints across 25 files

================================================================================
HOW CLIENTS ACTUALLY WORK TODAY
================================================================================

WORK SUBMISSION PATTERN A: Direct Queue (Recommended)
   POST /api/work/initiate {work_type, basket_id, payload, priority}
   → Creates agent_processing_queue entry
   → Returns work_id
   → Client polls /api/work/{work_id}/status

WORK SUBMISSION PATTERN B: Basket + Dump (Legacy)
   POST /baskets/new {idempotency_key, basket: {name}}
   POST /dumps/new {basket_id, content}
   → Awaits canonical queue processor to claim

SUBSTRATE GOVERNANCE PATTERN: Block Proposals
   POST /blocks/baskets/{id}/propose {block: {...}}
   → Creates proposals table entry (status='pending')
   → [User reviews in UI]
   POST /blocks/{id}/approve
   → Executes proposal_executions.execute()
   → Updates blocks, records timeline_events

DIRECT DOCUMENT PATTERN (UNGOVERNED)
   POST /api/documents/compose-contextual {basket_id, intent}
   → Creates documents table entry immediately
   → No proposal, no approval, no governance

DIRECT REFLECTION PATTERN (UNGOVERNED)
   POST /api/reflections/compute_window {start, end}
   → Creates reflection_cache entry immediately
   → No approval workflow

================================================================================
V4 ORPHANED INFRASTRUCTURE
================================================================================

SCHEMA LAYER (Migration 20251031_work_orchestration_layer.sql)
   work_sessions
   ├─ workspace_id, basket_id, initiated_by_user_id
   ├─ task_intent, task_type (research|synthesis|analysis|composition|update)
   ├─ status (initialized|in_progress|awaiting_checkpoint|awaiting_final_approval|approved|rejected|failed)
   ├─ approval_strategy (checkpoint_required|final_only|auto_approve_low_risk)
   ├─ reasoning_trail, context_snapshot
   ├─ artifacts_count, substrate_mutations_count
   └─ Indices: workspace, basket, status, user, agent

   work_artifacts
   ├─ work_session_id (FK)
   ├─ artifact_type (block_proposal|block_update|document_creation|insight|external_deliverable)
   ├─ content (jsonb)
   ├─ becomes_block_id, supersedes_block_id, creates_document_id
   ├─ agent_confidence (0.0-1.0)
   ├─ status (draft|pending_review|approved|rejected|applied_to_substrate)
   ├─ risk_level, risk_factors (jsonb)
   ├─ reviewed_by_user_id, reviewed_at, review_decision
   └─ Indices: session, status, type, block

   work_checkpoints
   ├─ work_session_id (FK)
   ├─ checkpoint_sequence, checkpoint_type (plan_approval|mid_work_review|artifact_review|final_approval)
   ├─ review_scope, artifacts_at_checkpoint (uuid[])
   ├─ agent_confidence, agent_reasoning, agent_summary
   ├─ status (pending|approved|rejected|skipped)
   ├─ reviewed_by_user_id, reviewed_at, user_decision, user_feedback
   ├─ changes_requested (jsonb), risk_level, risk_factors
   └─ UNIQUE(work_session_id, checkpoint_sequence)

   work_iterations
   ├─ work_session_id (FK), iteration_number
   ├─ triggered_by (checkpoint_rejection|user_feedback|agent_self_correction|context_staleness)
   ├─ changes_applied, iteration_artifacts
   └─ completed_at

   work_context_mutations
   ├─ work_session_id (FK)
   ├─ mutation_type (block_created|block_modified|block_deleted|relationship_added|relationship_removed)
   ├─ affected_substrate_ids (uuid[])
   ├─ before_state, after_state (jsonb)
   └─ created_at

CODE LAYER (governance/unified_approval.py)
   class UnifiedApprovalOrchestrator:
      async def review_work_session(
         work_session_id: UUID,
         user_id: UUID,
         decision: WorkReviewDecision
      ) → WorkReviewResult
      
   Supports:
   - Multi-stage checkpoints
   - Per-artifact decisions (apply_to_substrate|save_as_draft|reject)
   - Risk assessment
   - Iteration feedback
   - Unified mutations → timeline events

API LAYER (governance/unified_approval.py)
   Status: NOT WIRED TO ANY ENDPOINT
   Missing:
   ✗ POST /api/work/sessions/create
   ✗ POST /api/work/{id}/checkpoints/{id}/review
   ✗ POST /api/work/{id}/review
   ✗ GET  /api/work/{id}/artifacts
   ✗ POST /api/work/{id}/iterate

================================================================================
DATABASE REALITY CHECK (Table Liveliness)
================================================================================

LIVE TABLES (Active Daily Operations):
   agent_processing_queue    100s-1000s rows/day    ✓ Queue processing
   baskets                   10s-100s rows/day      ✓ Basket creation
   blocks                    100s-1000s rows/day    ✓ Substrate mutations
   proposals                 100s rows/day          ✓ Governance proposals
   documents                 100s rows/day          ✓ Document composition
   timeline_events           1000s+ rows/day        ✓ Audit trail

ORPHANED TABLES (0 rows/day):
   work_sessions             0 rows/day             ✗ No writes
   work_artifacts            0 rows/day             ✗ No writes
   work_checkpoints          0 rows/day             ✗ No writes
   work_iterations           0 rows/day             ✗ No writes
   work_context_mutations    0 rows/day             ✗ No writes

================================================================================
GAP ANALYSIS (Current vs. V4 Design)
================================================================================

Feature                | v2.1 Implementation | V4 Design        | Status
-----------------------|-------------------|------------------|--------
Work Creation          | ✓ Queue            | ✓ Sessions       | Missing session API
Work Status Tracking   | ✓ agent_queue      | ✓ work_sessions  | API only changes refs
Single Approve/Reject  | ✓ Binary           | ✗ Removed        | Removed for multi-stage
Per-Artifact Decisions | ✗ Not possible     | ✓ Dict[id, dec]  | **Missing API**
Multi-Stage Approval   | ✗ Single stage     | ✓ 4 checkpoint   | **Missing API**
Rework/Iteration       | ~ Limited retry    | ✓ Full iteration | **Missing API**
Document Governance    | ✗ Direct mutation  | ✓ Planned        | Not wired
Reflection Governance  | ✗ Direct mutation  | ✓ Planned        | Not wired

Key Gap: V4 code + schema exist, but API routes not created.

================================================================================
DATA FLOW COMPARISON
================================================================================

CURRENT P1_SUBSTRATE FLOW:
   POST /baskets/new + POST /dumps/new
   → Canonical queue claims work
   → P0CaptureAgent extracts blocks
   → GovernanceDumpProcessor creates proposals
   → User reviews and approves
   → POST /blocks/{id}/approve executes
   → timeline_events recorded

CURRENT P4_COMPOSE FLOW:
   POST /api/documents/compose-contextual
   → Document created DIRECTLY
   → No proposal, no approval, no timeline
   → [GOVERNANCE MISSING]

V4 INTENDED FLOW (NOT IMPLEMENTED):
   POST /api/work/sessions/create {approval_strategy: checkpoint_required}
   → Agent produces work_artifacts
   → Checkpoint 1: Plan approval
   → Checkpoint 2: Mid-work review
   → Checkpoint 3: Final + per-artifact decisions
   → Per-artifact: apply_to_substrate | save_as_draft | reject
   → Mutations applied, work_context_mutations recorded
   → Status: [NOT WIRED TO API]

================================================================================
INTEGRATION POINT SUMMARY
================================================================================

What Agents/UI Actually Call:
   ✓ GET  /api/work/{id}/status           (polling)
   ✓ POST /api/work/initiate              (submit work)
   ✓ POST /baskets/new                    (create container)
   ✓ POST /blocks/baskets/{id}/propose    (propose block)
   ✓ POST /blocks/{id}/approve            (approve block)
   ✓ POST /api/documents/compose          (direct documents)
   ✓ POST /api/reflections/compute        (direct reflections)
   ✓ POST /mcp/activity/                  (log activity)

What Should Be Called (V4 Plan):
   ✗ POST /api/work/sessions/create
   ✗ POST /api/work/{id}/review
   ✗ POST /api/work/{id}/iterate

Baskets/Substrate/Yarns Definitions:
   Basket: Container (baskets table) for blocks, documents, work
   Substrate: Blocks + relationships + proposals + timeline
   Yarn: Legacy term; not in schema. "YARNNN" is naming convention only.

================================================================================
GOVERNANCE COVERAGE
================================================================================

Substrate Blocks:
   Flow: propose → user reviews → approve → execute → timeline
   Status: ✓ GOVERNED

Document Composition:
   Flow: direct creation
   Status: ✗ UNGOVERNED

Reflection Operations:
   Flow: direct computation
   Status: ✗ UNGOVERNED

V4 Vision:
   All three types unified under work_sessions + UnifiedApprovalOrchestrator
   Status: Design complete, API missing

================================================================================
RECOMMENDATIONS
================================================================================

TIER 1: IMMEDIATE (Wire V4 to API)
   1. Create 4 endpoints:
      POST /api/work/sessions/initiate
      POST /api/work/{id}/checkpoints/{id}/review
      POST /api/work/{id}/review
      GET  /api/work/{id}/artifacts
   
   2. Create 1 iteration endpoint:
      POST /api/work/{id}/iterate
   
   3. Timeline: 1-2 sprints

TIER 2: MEDIUM TERM (Governance Unification)
   1. Wrap document composition in work sessions
   2. Wrap reflections in work sessions
   3. Ensure all mutations → timeline_events + work_context_mutations
   
   4. Timeline: Q4 2025 - Q1 2026

TIER 3: LONG TERM (Schema Decision)
   Deadline: Q1 2026
   - If V4 adopted: Make standard governance model
   - If not adopted: Archive orphaned tables, consolidate under proposals

================================================================================
CONCLUSION
================================================================================

RightNow operates on Canon v2.1 with a functional but incomplete work queue.
V4 unified approval infrastructure is fully designed (database + code) but
completely unwired from API. The infrastructure targets a future where ALL
mutations (blocks, documents, reflections) flow through unified governance
with multi-stage checkpoints and per-artifact decisions.

Current state: Only block proposals use governance. Documents and reflections
bypass it entirely. V4 would fix this asymmetry.

Decision: Adopt V4 API routes by Q1 2026 or archive the orphaned schema layer.

================================================================================
Complete findings in: API_SURFACE_FINDINGS.md
================================================================================
