<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Realtime WebSocket Test</title>
    <style>
        body {
            font-family: 'Monaco', 'Consolas', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #2e7d32; color: white; }
        .error { background: #c62828; color: white; }
        .warning { background: #f57c00; color: white; }
        .info { background: #1976d2; color: white; }
        .log {
            background: #424242;
            border: 1px solid #616161;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .test-section {
            border: 1px solid #555;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .credentials {
            background: #1e1e1e;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Supabase Realtime WebSocket Test</h1>
        <p>Comprehensive browser-based testing of Supabase Realtime connections</p>
        
        <div class="credentials">
            <strong>Test Configuration:</strong><br>
            Supabase URL: https://galytxxkrbksilekmhcw.supabase.co<br>
            Test Basket ID: da75cf04-65e5-46ac-940a-74e2ffe077a2<br>
            Timestamp: <span id="timestamp"></span>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ Test Controls</h2>
        <button onclick="runAllTests()">ğŸš€ Run All Tests</button>
        <button onclick="clearLogs()">ğŸ§¹ Clear Logs</button>
        <button onclick="testBasicConnection()">ğŸ”— Test Basic Connection</button>
        <button onclick="testRealtimeSubscription()">ğŸ“¡ Test Realtime Subscription</button>
        <button onclick="testAuthentication()">ğŸ” Test Authentication</button>
        <button onclick="insertTestEvent()">ğŸ“¤ Insert Test Event</button>
    </div>

    <div class="container">
        <h2>ğŸ“Š Test Results</h2>
        <div id="status" class="status info">Ready to test...</div>
        <div id="log" class="log">Waiting for tests to run...\n</div>
    </div>

    <div class="container test-section">
        <h2>ğŸ”Œ WebSocket Connection Details</h2>
        <div id="websocket-info" class="log">No WebSocket connection yet...</div>
    </div>

    <div class="container test-section">
        <h2>ğŸ“¨ Realtime Events</h2>
        <div id="realtime-events" class="log">No realtime events received yet...</div>
    </div>

    <div class="container test-section">
        <h2>ğŸ” Authentication Details</h2>
        <div id="auth-info" class="log">No authentication info yet...</div>
    </div>

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://galytxxkrbksilekmhcw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhbHl0eHhrcmJrc2lsZWttaGN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTU3NjMsImV4cCI6MjA2MjMzMTc2M30.n9wrD3a_fep8GfeCRm0iflk-4Y47RYnLA0EeEECU7OY';
        const TEST_BASKET_ID = 'da75cf04-65e5-46ac-940a-74e2ffe077a2';

        // Global variables
        let supabase = null;
        let activeChannel = null;
        let testResults = {};

        // Helper functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = {
                'success': 'âœ…',
                'error': 'âŒ', 
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            // Update status
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function updateSection(sectionId, content) {
            document.getElementById(sectionId).textContent = content;
        }

        function clearLogs() {
            document.getElementById('log').textContent = '';
            document.getElementById('websocket-info').textContent = 'No WebSocket connection yet...';
            document.getElementById('realtime-events').textContent = 'No realtime events received yet...';
            document.getElementById('auth-info').textContent = 'No authentication info yet...';
            testResults = {};
        }

        // Initialize timestamp
        document.getElementById('timestamp').textContent = new Date().toLocaleString();

        // Test functions
        async function testBasicConnection() {
            log('Testing basic Supabase connection...', 'info');
            
            try {
                // Create Supabase client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: false
                    }
                });
                
                log('Supabase client created successfully', 'success');
                
                // Test basic query
                const { data, error } = await supabase
                    .from('baskets')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(`Basic query failed: ${error.message}`, 'error');
                    testResults.basicConnection = false;
                    return false;
                } else {
                    log(`Basic query successful - found ${data.length} baskets`, 'success');
                    testResults.basicConnection = true;
                    return true;
                }
                
            } catch (err) {
                log(`Connection test failed: ${err.message}`, 'error');
                testResults.basicConnection = false;
                return false;
            }
        }

        async function testAuthentication() {
            log('Testing authentication state...', 'info');
            
            if (!supabase) {
                log('No Supabase client available', 'error');
                return false;
            }

            try {
                // Get current session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                let authDetails = `Authentication Test Results:\n`;
                authDetails += `Session exists: ${session ? 'Yes' : 'No'}\n`;
                
                if (session) {
                    authDetails += `User ID: ${session.user.id}\n`;
                    authDetails += `Email: ${session.user.email || 'N/A'}\n`;
                    authDetails += `Token expires: ${new Date(session.expires_at * 1000)}\n`;
                    
                    // Parse JWT token
                    try {
                        const tokenPayload = JSON.parse(atob(session.access_token.split('.')[1]));
                        authDetails += `JWT Role: ${tokenPayload.role}\n`;
                        authDetails += `JWT Audience: ${tokenPayload.aud}\n`;
                        authDetails += `JWT Expires: ${new Date(tokenPayload.exp * 1000)}\n`;
                        authDetails += `Access Token (first 50 chars): ${session.access_token.substring(0, 50)}...\n`;
                        
                        log(`Authentication successful - Role: ${tokenPayload.role}`, 'success');
                    } catch (e) {
                        authDetails += `Could not parse JWT: ${e.message}\n`;
                        log('Could not parse JWT token', 'warning');
                    }
                } else {
                    authDetails += `No active session found\n`;
                    
                    // Parse anon key
                    try {
                        const anonPayload = JSON.parse(atob(SUPABASE_ANON_KEY.split('.')[1]));
                        authDetails += `Using anon key with role: ${anonPayload.role}\n`;
                        log(`No session - using anon role: ${anonPayload.role}`, 'info');
                    } catch (e) {
                        authDetails += `Could not parse anon key: ${e.message}\n`;
                    }
                }
                
                if (error) {
                    authDetails += `Session error: ${error.message}\n`;
                    log(`Session error: ${error.message}`, 'error');
                }
                
                updateSection('auth-info', authDetails);
                testResults.authentication = !error;
                return !error;
                
            } catch (err) {
                log(`Authentication test failed: ${err.message}`, 'error');
                updateSection('auth-info', `Authentication test error: ${err.message}`);
                testResults.authentication = false;
                return false;
            }
        }

        async function testRealtimeSubscription() {
            log('Testing Realtime subscription...', 'info');
            
            if (!supabase) {
                log('No Supabase client available', 'error');
                return false;
            }

            try {
                // Clean up existing channel
                if (activeChannel) {
                    supabase.removeChannel(activeChannel);
                    log('Cleaned up previous channel', 'info');
                }

                // Create new channel
                const channelName = `test-${Date.now()}`;
                log(`Creating channel: ${channelName}`, 'info');
                
                activeChannel = supabase
                    .channel(channelName)
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'basket_events',
                            filter: `payload->>basket_id=eq.${TEST_BASKET_ID}`
                        },
                        (payload) => {
                            const eventInfo = `Realtime Event Received:\n`;
                            const eventDetails = `Event Type: ${payload.eventType}\n` +
                                               `Table: ${payload.table}\n` +
                                               `Schema: ${payload.schema}\n` +
                                               `New Data: ${JSON.stringify(payload.new, null, 2)}\n` +
                                               `Old Data: ${JSON.stringify(payload.old, null, 2)}\n` +
                                               `Timestamp: ${new Date().toISOString()}\n`;
                            
                            updateSection('realtime-events', eventInfo + eventDetails);
                            log('Realtime event received!', 'success');
                        }
                    )
                    .subscribe((status, err) => {
                        log(`Subscription status: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                        
                        let wsInfo = `WebSocket Connection Info:\n`;
                        wsInfo += `Status: ${status}\n`;
                        wsInfo += `Channel: ${channelName}\n`;
                        
                        if (err) {
                            wsInfo += `Error: ${JSON.stringify(err, null, 2)}\n`;
                            log(`Subscription error: ${JSON.stringify(err)}`, 'error');
                        }
                        
                        // Try to access WebSocket details
                        if (activeChannel && activeChannel._socket) {
                            const socket = activeChannel._socket;
                            wsInfo += `WebSocket URL: ${socket.endPoint}\n`;
                            wsInfo += `WebSocket State: ${socket.readyState}\n`;
                            wsInfo += `WebSocket Params: ${JSON.stringify(socket.params, null, 2)}\n`;
                        }
                        
                        updateSection('websocket-info', wsInfo);
                        
                        if (status === 'SUBSCRIBED') {
                            testResults.realtimeSubscription = true;
                        } else if (status === 'CHANNEL_ERROR') {
                            testResults.realtimeSubscription = false;
                        }
                    });

                return true;
                
            } catch (err) {
                log(`Realtime subscription failed: ${err.message}`, 'error');
                updateSection('websocket-info', `Subscription error: ${err.message}`);
                testResults.realtimeSubscription = false;
                return false;
            }
        }

        async function insertTestEvent() {
            log('Inserting test event...', 'info');
            
            if (!supabase) {
                log('No Supabase client available', 'error');
                return false;
            }

            try {
                const testEventPayload = {
                    event_type: 'browser_test',
                    payload: {
                        basket_id: TEST_BASKET_ID,
                        message: 'Test event from browser',
                        timestamp: new Date().toISOString(),
                        test_id: Math.random().toString(36).substring(7)
                    }
                };

                const { data, error } = await supabase
                    .from('basket_events')
                    .insert(testEventPayload)
                    .select();

                if (error) {
                    log(`Test event insertion failed: ${error.message}`, 'error');
                    return false;
                } else {
                    log(`Test event inserted successfully: ${data[0]?.id}`, 'success');
                    return true;
                }
                
            } catch (err) {
                log(`Test event insertion error: ${err.message}`, 'error');
                return false;
            }
        }

        async function runAllTests() {
            log('ğŸš€ Starting comprehensive test suite...', 'info');
            clearLogs();
            
            const tests = [
                { name: 'Basic Connection', fn: testBasicConnection },
                { name: 'Authentication', fn: testAuthentication },
                { name: 'Realtime Subscription', fn: testRealtimeSubscription }
            ];

            for (const test of tests) {
                log(`Running ${test.name} test...`, 'info');
                const result = await test.fn();
                
                if (result) {
                    log(`âœ… ${test.name} test passed`, 'success');
                } else {
                    log(`âŒ ${test.name} test failed`, 'error');
                }
                
                // Wait a bit between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Wait a moment, then try inserting a test event
            await new Promise(resolve => setTimeout(resolve, 2000));
            log('Attempting to trigger realtime event...', 'info');
            await insertTestEvent();

            // Final summary
            setTimeout(() => {
                const passedTests = Object.values(testResults).filter(Boolean).length;
                const totalTests = Object.keys(testResults).length;
                
                if (passedTests === totalTests && totalTests > 0) {
                    log(`ğŸ‰ All tests passed (${passedTests}/${totalTests})`, 'success');
                } else {
                    log(`âš ï¸ Some tests failed (${passedTests}/${totalTests})`, 'warning');
                }
            }, 5000);
        }

        // Auto-run tests on page load
        window.onload = () => {
            log('Page loaded - ready for testing', 'info');
        };
    </script>
</body>
</html>