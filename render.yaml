# render.yaml - YARNNN v4.0 Mono-Repo Configuration (Phase 2: Architecture Refactor)
services:
  # Work Platform API - Consumer/Work-Facing Application (BFF Layer)
  - type: web
    name: yarnnn-work-platform-api
    env: python
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: uvicorn src.app.agent_server:app --host 0.0.0.0 --port 10000 --log-level debug
    root: work-platform/api/
    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      # Phase 3: BFF Communication with Substrate API
      - key: SUBSTRATE_API_URL
        value: https://yarnnn-substrate-api.onrender.com
      - key: SUBSTRATE_SERVICE_SECRET
        sync: false

  # Substrate API - P0-P4 Agent Pipeline + Memory/Context Domain
  - type: web
    name: yarnnn-substrate-api
    env: python
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: uvicorn src.app.agent_server:app --host 0.0.0.0 --port 10000 --log-level debug
    root: substrate-api/api/
    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: MCP_SHARED_SECRET
        sync: false
      # Phase 3: Service-to-Service Authentication (disabled by default)
      - key: ENABLE_SERVICE_AUTH
        value: "false"
      - key: SUBSTRATE_SERVICE_SECRET
        sync: false
      - key: ALLOWED_SERVICES
        value: "platform-api,chatgpt-app"

  - type: web
    name: yarnnn-chatgpt-app
    env: node
    root: mcp-server/adapters/openai-apps
    buildCommand: npm install && npm run build
    startCommand: npm run start
    envVars:
      - key: APPS_BASE_URL
        sync: false
      - key: OPENAI_CLIENT_ID
        sync: false
      - key: OPENAI_CLIENT_SECRET
        sync: false
      - key: OPENAI_REDIRECT_URI
        sync: false
      - key: OAUTH_AUTH_URL
        sync: false
      - key: OAUTH_TOKEN_URL
        sync: false
      - key: YARNNN_API_URL
        value: https://api.yarnnn.com
      - key: YARNNN_API_DOMAIN
        value: api.yarnnn.com
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: ENCRYPTION_KEY
        sync: false
      - key: MCP_SHARED_SECRET
        sync: false
      - key: PORT
        value: "4312"
